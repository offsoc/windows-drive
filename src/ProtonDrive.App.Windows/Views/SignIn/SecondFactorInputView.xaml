<UserControl
    x:Class="ProtonDrive.App.Windows.Views.SignIn.SecondFactorInputView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:b="http://schemas.microsoft.com/xaml/behaviors"
    xmlns:behaviors="clr-namespace:ProtonDrive.App.Windows.Toolkit.Behaviors"
    xmlns:converters="clr-namespace:ProtonDrive.App.Windows.Toolkit.Converters"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:loc="clr-namespace:ProtonDrive.App.Windows.Resources"
    xmlns:local="clr-namespace:ProtonDrive.App.Windows.Views.SignIn"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d"
    d:DataContext="{d:DesignInstance local:SecondFactorInputViewModel}">
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <TextBlock
            Grid.Row="0"
            Text="{loc:Resource SignIn_Title_2FA}"
            FontSize="24"
            HorizontalAlignment="Center"
            Margin="0,30,0,0" />

        <ListBox
            Grid.Row="1"
            ItemsSource="{Binding EnabledPages}"
            SelectedItem="{Binding CurrentPage}"
            SelectionMode="Single"
            Visibility="{Binding HasMultipleEnabledPages, Converter={x:Static converters:BooleanToVisibilityConverter.FalseIsCollapsed}}"
            HorizontalAlignment="Center"
            Margin="0,10,0,0">
            <ListBox.ItemsPanel>
                <ItemsPanelTemplate>
                    <StackPanel Orientation="Horizontal" />
                </ItemsPanelTemplate>
            </ListBox.ItemsPanel>

            <ListBox.ItemTemplate>
                <DataTemplate>
                    <TextBlock Text="{Binding Converter={x:Static converters:EnumToDisplayTextConverter.Instance}}" />
                </DataTemplate>
            </ListBox.ItemTemplate>
        </ListBox>

        <Grid
            Grid.Row="2"
            Visibility="{Binding CurrentPage, Converter={x:Static converters:ObjectEqualityToVisibilityConverter.NotEqualIsCollapsed}, ConverterParameter={x:Static local:SecondFactorInputPage.NotSupported}}">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>

            <Image
                Grid.Row="0"
                Source="/Views/SignIn/Banner.No2FA.DarkTheme.png"
                Height="140"
                Margin="0,40,0,0" />

            <TextBlock
                Grid.Row="1"
                Text="{loc:Resource SignIn_Text_No2FAMethodFound}"
                FontSize="{StaticResource TextBlock.Default.FontSize}"
                Foreground="{StaticResource GrayBrush}"
                TextWrapping="Wrap"
                HorizontalAlignment="Center"
                Margin="0,30,0,0" />
        </Grid>

        <Grid
            Grid.Row="2"
            Visibility="{Binding CurrentPage, Converter={x:Static converters:ObjectEqualityToVisibilityConverter.NotEqualIsCollapsed}, ConverterParameter={x:Static local:SecondFactorInputPage.Totp}}">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>

            <Border
                Grid.Row="0"
                Background="{StaticResource ErrorPanel.Background.SignIn}"
                BorderThickness="0"
                Style="{StaticResource RoundedSection.DarkTheme.Error}"
                Visibility="{Binding Path=(Validation.HasError), ElementName=CodeBox, Converter={x:Static converters:BooleanToVisibilityConverter.FalseIsHidden}}"
                Margin="0,10,0,0">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="*" />
                    </Grid.ColumnDefinitions>

                    <TextBlock
                        Grid.Column="0"
                        Text="{StaticResource icon-error-full}"
                        FontSize="18"
                        Foreground="{StaticResource ErrorPanel.Foreground.SignIn}"
                        Style="{StaticResource FontIconStyle}"
                        VerticalAlignment="Center" />

                    <TextBlock
                        Grid.Column="1"
                        Text="{Binding Path=(Validation.Errors)[0].ErrorContent, ElementName=CodeBox}"
                        TextTrimming="CharacterEllipsis"
                        VerticalAlignment="Center"
                        Margin="15,0,0,0">
                        <b:Interaction.Behaviors>
                            <behaviors:TextBlockAutoToolTipBehavior />
                        </b:Interaction.Behaviors>
                    </TextBlock>
                </Grid>
            </Border>

            <TextBlock
                Grid.Row="1"
                Text="{loc:Resource SignIn_Text_2FACode}"
                FontSize="{StaticResource TextBlock.Default.FontSize}"
                Foreground="{StaticResource GrayBrush}"
                TextWrapping="Wrap"
                HorizontalAlignment="Center"
                Margin="0,30,0,0" />

            <local:TwoFactorAuthenticationCodeBox
                x:Name="CodeBox"
                Grid.Row="2"
                Code="{Binding TotpCode, UpdateSourceTrigger=PropertyChanged}"
                Margin="0,20,0,0">
                <Validation.ErrorTemplate>
                    <ControlTemplate />
                </Validation.ErrorTemplate>

                <b:Interaction.Behaviors>
                    <behaviors:TotpDigitsBehavior />
                </b:Interaction.Behaviors>

                <b:Interaction.Triggers>
                    <b:EventTrigger EventName="CodeCompleted">
                        <b:InvokeCommandAction Command="{Binding ContinueSigningInCommand}" />
                    </b:EventTrigger>
                </b:Interaction.Triggers>
            </local:TwoFactorAuthenticationCodeBox>

            <Button
                AutomationProperties.AutomationId="ContinueButton"
                Grid.Row="3"
                Content="{loc:Resource SignIn_Button_Authenticate}"
                Command="{Binding ContinueSigningInCommand}"
                IsDefault="True"
                Style="{StaticResource PrimaryButtonStyle}"
                Height="32"
                Margin="0,30,0,0" />
        </Grid>

        <Grid
            Grid.Row="2"
            Visibility="{Binding CurrentPage, Converter={x:Static converters:ObjectEqualityToVisibilityConverter.NotEqualIsCollapsed}, ConverterParameter={x:Static local:SecondFactorInputPage.Fido2}}">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>

            <Image
                Grid.Row="0"
                Source="/Views/SignIn/SecurityKey.DarkTheme.png"
                Visibility="{Binding IsFido2Available, Converter={x:Static converters:BooleanToVisibilityConverter.FalseIsCollapsed}}"
                Height="140"
                Margin="0,0,0,0" />

            <Image
                Grid.Row="0"
                Source="/Views/SignIn/SecurityKey.NotSupported.DarkTheme.png"
                Visibility="{Binding IsFido2Available, Converter={x:Static converters:BooleanToVisibilityConverter.TrueIsCollapsed}}"
                Height="140"
                Margin="0,0,0,0" />

            <TextBlock
                Grid.Row="1"
                Text="{loc:Resource SignIn_Text_SecurityKeyNotSupported}"
                FontSize="{StaticResource TextBlock.Default.FontSize}"
                Foreground="{StaticResource GrayBrush}"
                TextWrapping="Wrap"
                Visibility="{Binding IsFido2Available, Converter={x:Static converters:BooleanToVisibilityConverter.TrueIsCollapsed}}"
                HorizontalAlignment="Center"
                Margin="0,10,0,0" />

            <WrapPanel
                Grid.Row="1"
                Orientation="Horizontal"
                Visibility="{Binding IsFido2Available, Converter={x:Static converters:BooleanToVisibilityConverter.FalseIsCollapsed}}"
                Margin="0,10,0,0">
                <TextBlock
                    Text="{loc:Resource SignIn_Text_SecurityKey}"
                    FontSize="{StaticResource TextBlock.Default.FontSize}"
                    Foreground="{StaticResource GrayBrush}"
                    TextWrapping="Wrap"
                    HorizontalAlignment="Center"
                    Margin="0,10,0,0" />

                <Button
                    AutomationProperties.AutomationId="LearnMoreButton"
                    Content="{loc:Resource SignIn_Button_LearnMore}"
                    Command="{Binding LearnMoreCommand}"
                    Style="{StaticResource HyperlinkButtonStyle}"
                    HorizontalAlignment="Left" />
            </WrapPanel>

            <Button
                AutomationProperties.AutomationId="AuthenticateWithFido2Button"
                Grid.Row="2"
                Content="{loc:Resource SignIn_Button_Authenticate}"
                Command="{Binding ContinueSigningInCommand}"
                IsDefault="True"
                IsEnabled="{Binding IsFido2Available}"
                Style="{StaticResource PrimaryButtonStyle}"
                Height="32"
                Margin="0,30,0,0" />
        </Grid>

        <Button
            AutomationProperties.AutomationId="SignInAsAnotherUserButton"
            Grid.Row="3"
            Content="{loc:Resource SignIn_Button_Back}"
            Command="{Binding RestartSignInCommand}"
            Style="{StaticResource HyperlinkButtonStyle}"
            HorizontalAlignment="Center"
            Margin="0,15,0,0" />
    </Grid>
</UserControl>
